#!/bin/bash

# -------------------------------
# 1) –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# -------------------------------
RESULTS_DIR="allure-results"
DOCS_DIR="docs"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
REPORT_DIR="$DOCS_DIR/report_$TIMESTAMP"

# -------------------------------
# 2) URL GitHub Pages (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
# -------------------------------
GH_PAGES_BASE="https://antongetfive.github.io/maestro-tests-buy-flow/"
GH_REPORT_URL="${GH_PAGES_BASE}report_$TIMESTAMP/"

# -------------------------------
# 3) –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ allure-results
# -------------------------------
if [ ! -d "$RESULTS_DIR" ]; then
  echo "‚ùå –ü–∞–ø–∫–∞ $RESULTS_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
  exit 1
fi

# -------------------------------
# 4) –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ—Ç—á—ë—Ç–∞
# -------------------------------
echo "üìÅ –°–æ–∑–¥–∞—é –ø–∞–ø–∫—É –æ—Ç—á—ë—Ç–∞: $REPORT_DIR"
mkdir -p "$REPORT_DIR"

# -------------------------------
# 5) –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Allure –æ—Ç—á—ë—Ç–∞
# -------------------------------
echo "üìä –ì–µ–Ω–µ—Ä–∏—Ä—É—é Allure Report..."
allure generate "$RESULTS_DIR" --clean -o "$REPORT_DIR"

if [ $? -ne 0 ]; then
  echo "‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞!"
  exit 1
fi

# -------------------------------
# 6) –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
# -------------------------------
echo "üì§ –ö–æ–º–º–∏—Ç –∏ –ø—É—à –æ—Ç—á—ë—Ç–∞..."
git add -A

if git diff --cached --quiet; then
  echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–æ—Ç—á—ë—Ç –Ω–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)."
else
  git commit -m "Add report $TIMESTAMP"
  git push origin HEAD
fi

# -------------------------------
# 7) –ì–æ—Ç–æ–≤–æ ‚Äî –≤—ã–≤–æ–¥–∏–º —Å—Å—ã–ª–∫–∏
# -------------------------------
echo ""
echo "üéâ –û—Ç—á—ë—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!"
echo "----------------------------------------"
echo "üìÑ –£–Ω–∏–∫–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç—á—ë—Ç:"
echo "$GH_REPORT_URL"
echo ""
echo "üìö –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—Ç—á—ë—Ç–æ–≤:"
echo "$GH_PAGES_BASE"
echo "----------------------------------------"
